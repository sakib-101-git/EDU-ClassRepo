<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Files - EDU ClassRepo</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .course-header-banner {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 28px 30px;
            border-radius: var(--radius-lg);
            margin-bottom: 28px;
            position: relative;
            overflow: hidden;
        }
        
        .course-header-banner::before {
            content: '';
            position: absolute;
            top: -40px;
            right: -40px;
            width: 150px;
            height: 150px;
            background: rgba(255,255,255,0.08);
            border-radius: 50%;
        }
        
        .course-header-banner::after {
            content: '';
            position: absolute;
            bottom: -30px;
            left: 30%;
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
        }
        
        .course-header-banner h1 {
            font-size: 24px;
            margin-bottom: 8px;
            position: relative;
        }
        
        .course-header-banner p {
            opacity: 0.9;
            font-size: 14px;
            position: relative;
        }
        
        .back-link {
            color: var(--text-medium);
            text-decoration: none;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 20px;
            transition: var(--transition);
        }
        
        .back-link:hover {
            color: var(--primary);
        }
        
        .upload-section {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-book-reader"></i>
                EDU ClassRepo
            </div>
            <div class="user-menu">
                <div class="user-info">
                    <div class="user-name" id="user-name">Loading...</div>
                    <div class="user-role" id="user-role">-</div>
                </div>
                <a href="settings.html" class="profile-avatar" id="profile-avatar" title="Account Settings">
                    <i class="fas fa-user-circle" style="font-size: 24px; color: #5c6b7a;"></i>
                </a>
            </div>
        </header>

        <div class="app-body">
            <!-- Sidebar -->
            <nav class="sidebar"></nav>

            <!-- Main Content -->
            <main class="main-content">
                <a href="dashboard.html" class="back-link">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
                
                <div class="course-header-banner" id="course-banner">
                    <h1 id="course-title">Loading...</h1>
                    <p id="course-meta"><i class="fas fa-user-tie"></i> Instructor • <i class="fas fa-building"></i> Department</p>
                </div>
                
                <div class="upload-section">
                    <button class="btn btn-primary" onclick="openModal('upload-modal')">
                        <i class="fas fa-upload"></i> Upload Notes
                    </button>
                </div>

                <!-- File List -->
                <div class="file-list" id="file-list">
                    <!-- Files will be loaded here -->
                </div>
            </main>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal" id="upload-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Upload Notes</h3>
                <button class="modal-close" onclick="closeModal('upload-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="upload-form" onsubmit="handleUpload(event)">
                    <div class="form-group">
                        <label>Select File</label>
                        <input type="file" class="form-input" id="file-input" required 
                               style="padding: 10px; cursor: pointer;">
                    </div>
                    <div class="alert alert-warning" id="pending-notice">
                        <i class="fas fa-info-circle"></i> 
                        Your file will be reviewed by an admin before it becomes visible to others.
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-cloud-upload-alt"></i> Upload File
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Check authentication
        const user = checkAuth();
        
        // Course color mapping
        const deptColors = {
            'CSE': '#5c6b7a',
            'EEE': '#6b7a5c',
            'BBA': '#7a6b5c',
            'ENG': '#5c7a7a',
            'LAW': '#7a5c6b',
            'PHA': '#6b5c7a'
        };
        
        // Get course ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = parseInt(urlParams.get('id'));
        let currentCourse = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadHeader();
            loadSidebar('');
            
            // Load course info
            const courses = JSON.parse(localStorage.getItem('edu_courses')) || [];
            currentCourse = courses.find(c => c.id === courseId);
            
            if (!currentCourse) {
                document.getElementById('course-title').textContent = 'Course Not Found';
                document.getElementById('course-meta').textContent = '';
                return;
            }
            
            // Set course banner color based on department
            const bannerColor = deptColors[currentCourse.dept] || '#722f37';
            document.getElementById('course-banner').style.background = 
                `linear-gradient(135deg, ${bannerColor}, ${adjustColor(bannerColor, -30)})`;
            
            document.getElementById('course-title').textContent = 
                `${currentCourse.code}: ${currentCourse.title}`;
            document.getElementById('course-meta').innerHTML = 
                `<i class="fas fa-user-tie"></i> ${currentCourse.instructor || 'TBA'} &nbsp;•&nbsp; <i class="fas fa-building"></i> ${currentCourse.dept}`;
            document.title = `${currentCourse.code} - EDU ClassRepo`;
            
            // Hide pending notice for admin
            if (user.role === 'admin') {
                document.getElementById('pending-notice').classList.add('hidden');
            }
            
            loadCourseFiles();
        });

        // Adjust color brightness
        function adjustColor(hex, amount) {
            const num = parseInt(hex.replace('#', ''), 16);
            const r = Math.max(0, Math.min(255, (num >> 16) + amount));
            const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
            const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
            return `#${(1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1)}`;
        }

        // Load files for this course
        function loadCourseFiles() {
            const isAdmin = user.role === 'admin';
            const files = getCourseFiles(courseId, !isAdmin);
            const fileList = document.getElementById('file-list');
            
            if (files.length === 0) {
                fileList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-folder-open"></i>
                        <h3>No files uploaded yet</h3>
                        <p>Be the first to share notes for this course!</p>
                    </div>
                `;
                return;
            }
            
            fileList.innerHTML = files.map(file => {
                const icon = getFileIcon(file.name);
                const canDelete = isAdmin || file.uploadedByEmail === user.email;
                const isPending = file.status === 'pending';
                
                return `
                    <div class="file-item" ${isPending ? 'style="opacity: 0.7;"' : ''}>
                        <div class="file-icon ${icon.class}">
                            <i class="fas ${icon.icon}"></i>
                        </div>
                        <div class="file-info">
                            <div class="file-name">${file.name}</div>
                            <div class="file-meta">
                                ${file.size} • Uploaded by ${file.uploadedBy} • ${file.uploadDate}
                                ${isPending ? '<span class="badge badge-pending" style="margin-left: 8px;">Pending</span>' : ''}
                            </div>
                        </div>
                        <div class="file-actions">
                            ${!isPending || isAdmin ? `
                                <button class="btn btn-secondary btn-small" onclick="downloadFile('${file.name}')">
                                    <i class="fas fa-download"></i>
                                </button>
                            ` : ''}
                            ${canDelete ? `
                                <button class="btn btn-danger btn-small" onclick="deleteFile(${file.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Handle file upload
        function handleUpload(event) {
            event.preventDefault();
            
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const fileSize = (file.size / 1024).toFixed(1) + ' KB';
            
            uploadFile(courseId, file.name, fileSize);
            
            closeModal('upload-modal');
            document.getElementById('upload-form').reset();
            loadCourseFiles();
            
            if (user.role === 'admin') {
                alert('File uploaded successfully!');
            } else {
                alert('File uploaded! It will be visible after admin approval.');
            }
        }

        // Download file (simulated)
        function downloadFile(fileName) {
            const content = `Simulated download for: ${fileName}\n\nThis is a demo file. In production, actual file would be downloaded.`;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
