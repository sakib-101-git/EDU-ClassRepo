<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Files - EDU ClassRepo</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .course-banner {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 28px 30px;
            border-radius: var(--radius-lg);
            margin-bottom: 28px;
            position: relative;
            overflow: hidden;
        }
        
        .course-banner::before {
            content: '';
            position: absolute;
            top: -40px;
            right: -40px;
            width: 150px;
            height: 150px;
            background: rgba(255,255,255,0.08);
            border-radius: 50%;
        }
        
        .course-banner h1 {
            font-size: 24px;
            margin-bottom: 8px;
            position: relative;
        }
        
        .course-banner p {
            opacity: 0.9;
            font-size: 14px;
            position: relative;
        }
        
        .back-link {
            color: var(--text-medium);
            text-decoration: none;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 20px;
        }
        
        .back-link:hover {
            color: var(--primary);
        }
        
        .upload-section {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-book-reader"></i>
                EDU ClassRepo
            </div>
            <div class="user-menu">
                <div class="user-info">
                    <div class="user-name" id="user-name">Loading...</div>
                    <div class="user-role" id="user-role">-</div>
                </div>
                <a href="settings.html" class="profile-avatar" title="Settings">
                    <i class="fas fa-user-circle" style="font-size: 24px; color: #5c6b7a;"></i>
                </a>
            </div>
        </header>

        <div class="app-body">
            <!-- Sidebar -->
            <nav class="sidebar"></nav>

            <!-- Main Content -->
            <main class="main-content">
                <a href="my-courses.html" class="back-link">
                    <i class="fas fa-arrow-left"></i> Back to My Courses
                </a>
                
                <div class="course-banner" id="course-banner">
                    <h1 id="course-title">Loading...</h1>
                    <p id="course-meta"></p>
                </div>
                
                <div class="upload-section">
                    <button class="btn btn-primary" onclick="openModal('upload-modal')">
                        <i class="fas fa-upload"></i> Upload Notes
                    </button>
                </div>

                <!-- File List -->
                <div class="file-list" id="file-list">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <h3>Loading files...</h3>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal" id="upload-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Upload Notes</h3>
                <button class="modal-close" onclick="closeModal('upload-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="upload-form" onsubmit="handleUpload(event)">
                    <div class="form-group">
                        <label>Select File</label>
                        <input type="file" class="form-input" id="file-input" required 
                               style="padding: 10px; cursor: pointer;">
                    </div>
                    <div class="alert alert-warning" id="pending-notice">
                        <i class="fas fa-info-circle"></i> 
                        Your file will be reviewed by admin before becoming visible.
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-cloud-upload-alt"></i> Upload
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        /*
         * Course Page Script
         */
        
        const user = checkAuth();
        
        // Get course ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = parseInt(urlParams.get('id'));
        
        let currentCourse = null;
        
        // Department colors
        const deptColors = {
            'CSE': '#5c6b7a',
            'EEE': '#6b7a5c',
            'BBA': '#7a6b5c',
            'ENG': '#5c7a7a',
            'ECO': '#7a705c',
            'GED': '#6b6b7a'
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            loadHeader();
            loadSidebar('');
            
            // Hide pending notice for admin
            if (user?.role === 'admin') {
                document.getElementById('pending-notice').classList.add('hidden');
            }
            
            await loadCourse();
        });

        // Load course details
        async function loadCourse() {
            currentCourse = await api(`/courses/${courseId}`);
            
            if (!currentCourse || currentCourse.error) {
                document.getElementById('course-title').textContent = 'Course Not Found';
                return;
            }
            
            // Set banner color
            const color = deptColors[currentCourse.department] || '#722f37';
            document.getElementById('course-banner').style.background = 
                `linear-gradient(135deg, ${color}, ${darken(color)})`;
            
            // Set course info
            document.getElementById('course-title').textContent = 
                `${currentCourse.code}: ${currentCourse.title}`;
            document.getElementById('course-meta').innerHTML = 
                `<i class="fas fa-user-tie"></i> ${currentCourse.instructor || 'TBA'} &nbsp;•&nbsp; 
                 <i class="fas fa-building"></i> ${currentCourse.department}`;
            document.title = `${currentCourse.code} - EDU ClassRepo`;
            
            await loadFiles();
        }

        // Darken color for gradient
        function darken(hex) {
            const num = parseInt(hex.replace('#', ''), 16);
            const r = Math.max(0, (num >> 16) - 30);
            const g = Math.max(0, ((num >> 8) & 0xFF) - 30);
            const b = Math.max(0, (num & 0xFF) - 30);
            return `#${(1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1)}`;
        }

        // Load course files
        async function loadFiles() {
            const files = await loadCourseFiles(courseId);
            const fileList = document.getElementById('file-list');
            const isAdmin = user?.role === 'admin';
            
            if (!files || files.length === 0) {
                fileList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-folder-open"></i>
                        <h3>No files uploaded yet</h3>
                        <p>Be the first to share notes for this course!</p>
                    </div>
                `;
                return;
            }
            
            fileList.innerHTML = files.map(file => {
                const icon = getFileIcon(file.file_name);
                const size = file.file_size ? (file.file_size / 1024).toFixed(1) + ' KB' : '';
                
                return `
                    <div class="file-item">
                        <div class="file-icon ${icon.class}">
                            <i class="fas ${icon.icon}"></i>
                        </div>
                        <div class="file-info">
                            <div class="file-name">${file.file_name}</div>
                            <div class="file-meta">
                                ${size} • Uploaded by ${file.uploader_name}
                            </div>
                        </div>
                        <div class="file-actions">
                            <a href="/uploads/${file.file_path}" download class="btn btn-secondary btn-small">
                                <i class="fas fa-download"></i>
                            </a>
                            ${isAdmin ? `
                                <button class="btn btn-danger btn-small" onclick="handleDeleteFile(${file.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Handle file upload
        async function handleUpload(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('courseId', courseId);
            
            try {
                const res = await fetch(`${API}/files`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${getToken()}` },
                    body: formData
                });
                const data = await res.json();
                
                closeModal('upload-modal');
                document.getElementById('upload-form').reset();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert(data.message);
                    await loadFiles();
                }
            } catch (err) {
                alert('Upload failed');
            }
        }

        // Handle delete file
        async function handleDeleteFile(fileId) {
            if (await deleteFile(fileId)) {
                await loadFiles();
            }
        }
    </script>
</body>
</html>
