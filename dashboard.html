<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - EDU ClassRepo</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-book-reader"></i>
                EDU ClassRepo
            </div>
            <div class="user-menu">
                <div class="user-info">
                    <div class="user-name" id="user-name">Loading...</div>
                    <div class="user-role" id="user-role">-</div>
                </div>
                <a href="settings.html" class="profile-avatar" title="Settings">
                    <i class="fas fa-user-circle" style="font-size: 24px; color: #5c6b7a;"></i>
                </a>
            </div>
        </header>

        <div class="app-body">
            <!-- Sidebar -->
            <nav class="sidebar"></nav>

            <!-- Main Content -->
            <main class="main-content">
                <div class="page-header">
                    <h1 class="page-title">Available Courses</h1>
                    <div class="filter-controls">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="search-input" 
                                   placeholder="Search courses..." onkeyup="filterCourses()">
                        </div>
                        
                        <select class="filter-select" id="dept-filter" onchange="filterCourses()">
                            <option value="All">All Departments</option>
                            <option value="CSE">CSE</option>
                            <option value="EEE">EEE</option>
                            <option value="BBA">BBA</option>
                            <option value="ENG">English</option>
                            <option value="ECO">Economics</option>
                            <option value="GED">General Education</option>
                        </select>
                        
                        <button class="btn btn-primary hidden" id="create-course-btn" onclick="openModal('create-course-modal')">
                            <i class="fas fa-plus"></i> Create Course
                        </button>
                    </div>
                </div>

                <!-- Course Grid -->
                <div class="course-grid" id="course-grid">
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i class="fas fa-spinner fa-spin"></i>
                        <h3>Loading courses...</h3>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Create Course Modal -->
    <div class="modal" id="create-course-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Course</h3>
                <button class="modal-close" onclick="closeModal('create-course-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="create-course-form" onsubmit="handleCreateCourse(event)">
                    <div class="form-group">
                        <label>Course Code</label>
                        <input type="text" class="form-input" id="course-code" placeholder="e.g., CSE 301" required>
                    </div>
                    <div class="form-group">
                        <label>Course Title</label>
                        <input type="text" class="form-input" id="course-title" placeholder="e.g., Database Systems" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Department</label>
                            <select class="form-select" id="course-dept" required>
                                <option value="CSE">CSE</option>
                                <option value="EEE">EEE</option>
                                <option value="BBA">BBA</option>
                                <option value="ENG">English</option>
                                <option value="ECO">Economics</option>
                                <option value="GED">General Education</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Instructor</label>
                            <input type="text" class="form-input" id="course-instructor" placeholder="Instructor name">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Create Course</button>
                </form>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        /*
         * Dashboard Page Script
         */
        
        const user = checkAuth();
        let allCourses = [];
        let enrolledCourses = [];
        
        // Department color classes
        const deptColors = {
            'CSE': 'course-cse',
            'EEE': 'course-eee',
            'BBA': 'course-bba',
            'ENG': 'course-eng',
            'ECO': 'course-eco',
            'GED': 'course-ged'
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            loadHeader();
            loadSidebar('dashboard');
            
            // Show create button for admin
            if (user?.role === 'admin') {
                document.getElementById('create-course-btn').classList.remove('hidden');
            }
            
            await loadDashboard();
        });

        // Load courses from API
        async function loadDashboard() {
            allCourses = await loadCourses();
            enrolledCourses = await loadEnrollments();
            renderCourses();
        }

        // Render course cards
        function renderCourses() {
            const deptFilter = document.getElementById('dept-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            let courses = allCourses;
            
            // Apply department filter
            if (deptFilter !== 'All') {
                courses = courses.filter(c => c.department === deptFilter);
            }
            
            // Apply search filter
            if (searchTerm) {
                courses = courses.filter(c => 
                    c.code.toLowerCase().includes(searchTerm) ||
                    c.title.toLowerCase().includes(searchTerm)
                );
            }
            
            const grid = document.getElementById('course-grid');
            const isAdmin = user?.role === 'admin';
            
            // Show empty state
            if (courses.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i class="fas fa-search"></i>
                        <h3>No courses found</h3>
                        <p>Try a different search or filter.</p>
                    </div>
                `;
                return;
            }
            
            // Render course cards
            grid.innerHTML = courses.map(course => {
                const isEnrolled = enrolledCourses.some(c => c.id === course.id);
                const colorClass = deptColors[course.department] || '';
                
                return `
                    <div class="course-card ${colorClass}">
                        <div class="card-header">
                            <h3>${course.code}: ${course.title}</h3>
                            <span><i class="fas fa-user-tie"></i> ${course.instructor || 'TBA'}</span>
                        </div>
                        <div class="card-body">
                            ${isAdmin ? `
                                <button class="btn btn-danger btn-small" onclick="handleDelete(${course.id})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            ` : `
                                ${isEnrolled ? `
                                    <a href="course.html?id=${course.id}" class="btn btn-secondary btn-small">
                                        <i class="fas fa-folder-open"></i> Open
                                    </a>
                                ` : `
                                    <button class="btn btn-primary btn-small" onclick="handleEnroll(${course.id})">
                                        <i class="fas fa-plus"></i> Enroll
                                    </button>
                                `}
                            `}
                        </div>
                        <div class="card-footer">
                            <span><i class="fas fa-building"></i> ${course.department}</span>
                            ${isEnrolled ? '<span class="text-success"><i class="fas fa-check-circle"></i> Enrolled</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter courses
        function filterCourses() {
            renderCourses();
        }

        // Handle enrollment
        async function handleEnroll(courseId) {
            if (await enrollCourse(courseId)) {
                await loadDashboard();
            }
        }

        // Handle delete (Admin)
        async function handleDelete(courseId) {
            if (await deleteCourse(courseId)) {
                await loadDashboard();
            }
        }

        // Handle create course (Admin)
        async function handleCreateCourse(e) {
            e.preventDefault();
            
            const code = document.getElementById('course-code').value;
            const title = document.getElementById('course-title').value;
            const dept = document.getElementById('course-dept').value;
            const instructor = document.getElementById('course-instructor').value;
            
            const result = await createCourse(code, title, dept, instructor);
            
            if (result.error) {
                alert('Error: ' + result.error);
                return;
            }
            
            closeModal('create-course-modal');
            document.getElementById('create-course-form').reset();
            await loadDashboard();
            alert('Course created!');
        }
    </script>
</body>
</html>
